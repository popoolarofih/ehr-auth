<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Patient Info & Records – EHR System</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    body {
      padding-top: 70px;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    .content { flex: 1 0 auto; }
    footer { flex-shrink: 0; }
    .loading-spinner { display: flex; justify-content: center; margin: 2rem 0; }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-success fixed-top">
    <div class="container">
      <a class="navbar-brand" href="#"><i class="fa-solid fa-hospital-user"></i> FUNAAB EHR System</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="nav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" href="patient-records.html"><i class="fa-solid fa-file-medical"></i> Records</a></li>
          <li class="nav-item"><a class="nav-link" href="appointments.html"><i class="fa-solid fa-calendar-check"></i> Appointments</a></li>
          <li class="nav-item"><a class="nav-link active" href="#"><i class="fa-solid fa-user-injured"></i> My Profile</a></li>
          <li class="nav-item"><a class="nav-link" href="prescriptions.html"><i class="fa-solid fa-pills"></i> Prescriptions</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="content">
    <div class="container">

      <!-- Patient Info Form -->
      <div class="card mb-4">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0"><i class="fa-solid fa-user-injured"></i> Update Patient Record</h5>
        </div>
        <div class="card-body">
          <form id="patientForm">
            <div class="row g-3">
              <div class="col-md-6">
                <label for="fullName" class="form-label">Full Name</label>
                <input type="text" id="fullName" class="form-control" required />
              </div>
              <div class="col-md-3">
                <label for="age" class="form-label">Age</label>
                <input type="number" id="age" class="form-control" required />
              </div>
              <div class="col-md-3">
                <label for="gender" class="form-label">Gender</label>
                <select id="gender" class="form-select" required>
                  <option value="">Select…</option>
                  <option value="Male">Male</option>
                  <option value="Female">Female</option>
                  <option value="Other">Other</option>
                </select>
              </div>
              <div class="col-12">
                <label for="address" class="form-label">Address</label>
                <input type="text" id="address" class="form-control" required />
              </div>
              <div class="col-12">
                <label for="medicalHistory" class="form-label">Medical History</label>
                <textarea id="medicalHistory" class="form-control" rows="4"></textarea>
              </div>
              <div class="col-12">
                <label for="recordUpload" class="form-label">Upload Supporting Document</label>
                <input type="file" id="recordUpload" class="form-control" accept=".pdf,.jpg,.png" />
              </div>
            </div>
            <div class="mt-3 text-end">
              <button type="submit" class="btn btn-success">
                <i class="fa-solid fa-floppy-disk"></i> Save Changes
              </button>
            </div>
          </form>
          <div id="formStatus" class="mt-2"></div>
        </div>
      </div>

      <!-- Prescription List for This Patient -->
      <div class="card">
        <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
          <h5 class="mb-0"><i class="fa-solid fa-pills"></i> My Prescriptions</h5>
        </div>
        <div class="card-body">
          <div id="prescLoading" class="loading-spinner">
            <div class="spinner-border text-success" role="status"><span class="visually-hidden">Loading...</span></div>
          </div>
          <div id="noPrescriptions" class="text-center text-muted d-none">
            <i class="fa-solid fa-folder-open fa-2x mb-2"></i>
            <p>No prescriptions found.</p>
          </div>
          <div class="table-responsive d-none" id="prescTableWrapper">
            <table class="table table-striped">
              <thead class="table-success">
                <tr>
                  <th>Date</th>
                  <th>Doctor</th>
                  <th>Medication</th>
                  <th>Notes</th>
                </tr>
              </thead>
              <tbody id="prescBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="bg-success text-white py-4 mt-4">
    <div class="container text-center">
      &copy; 2025 FUNAAB Electronic Health Record System. All rights reserved.
    </div>
  </footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
    // Database SDK: only DB exports
    import { getDatabase, ref, get, update } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-database.js";
    // Storage SDK: uploadBytes + getDownloadURL
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD_OKecRD3bFiZBFikhNauAPZRdz-FKp9w",
      authDomain: "ecommerce-fbaa8.firebaseapp.com",
      databaseURL: "https://ecommerce-fbaa8-default-rtdb.firebaseio.com",
      projectId: "ecommerce-fbaa8",
      storageBucket: "ecommerce-fbaa8.appspot.com",
      messagingSenderId: "296693502804",
      appId: "1:296693502804:web:d90e69e72e8983b753aec1"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const storage = getStorage(app);

    function getParam(name) {
      return new URL(window.location.href).searchParams.get(name);
    }
    const patientId = getParam('patientId');
    const form = document.getElementById('patientForm');
    const statusDiv = document.getElementById('formStatus');

    async function loadPatient() {
      const snap = await get(ref(db, `patient_records/${patientId}`));
      if (!snap.exists()) return;
      const data = snap.val();
      form.fullName.value = data.fullName || '';
      form.age.value = data.age || '';
      form.gender.value = data.gender || '';
      form.address.value = data.address || '';
      form.medicalHistory.value = data.medicalHistory || '';
    }

    form.addEventListener('submit', async e => {
      e.preventDefault();
      statusDiv.textContent = '';
      try {
        let docURL = null;
        const fileInput = document.getElementById('recordUpload');
        if (fileInput.files.length) {
          const file = fileInput.files[0];
          const path = `patient_docs/${patientId}/${file.name}`;
          const fileRef = storageRef(storage, path);
          await uploadBytes(fileRef, file);
          docURL = await getDownloadURL(fileRef);
        }
        const updates = {
          fullName: form.fullName.value.trim(),
          age: +form.age.value,
          gender: form.gender.value,
          address: form.address.value.trim(),
          medicalHistory: form.medicalHistory.value.trim(),
        };
        if (docURL) updates.documentURL = docURL;
        await update(ref(db, `patient_records/${patientId}`), updates);
        statusDiv.innerHTML = '<div class="alert alert-success">Record updated!</div>';
      } catch (err) {
        console.error(err);
        statusDiv.innerHTML = '<div class="alert alert-danger">Update failed. Try again.</div>';
      }
    });

    async function loadPrescriptions() {
      const snap = await get(ref(db, 'prescriptions'));
      document.getElementById('prescLoading').classList.add('d-none');
      const body = document.getElementById('prescBody');
      let found = false;
      if (snap.exists()) {
        snap.forEach(child => {
          const p = child.val();
          if (p.patientId === patientId) {
            found = true;
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${new Date(p.prescribedDate).toLocaleDateString()}</td>
              <td>${p.doctorName}</td>
              <td>${p.medication}</td>
              <td>${p.notes||''}</td>
            `;
            body.appendChild(tr);
          }
        });
      }
      if (!found) {
        document.getElementById('noPrescriptions').classList.remove('d-none');
      } else {
        document.getElementById('prescTableWrapper').classList.remove('d-none');
      }
    }

    if (!patientId) {
      alert('Missing patientId in URL');
    } else {
      loadPatient();
      loadPrescriptions();
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>